\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sty/equations}[Beatify multiple equations with comments and alignment.]

\RequirePackage{amsmath}        % provide basic math components
\RequirePackage{amssymb}        % provide QED square symbol
\RequirePackage{IEEEtrantools}  % provide {IEEEeqnarray} to align equations and their comments
\RequirePackage{array}          % provide {array} to draw a vertical line next to the comments
\RequirePackage{siunitx}        % provide \unit to display commentunits
\RequirePackage{etoolbox}       % add methods to an environment
\RequirePackage{xifthen}        % detect empty arguments


\makeatletter % Grant access to private commands (Name contains an @).

%%%%%%%%%%%%%%%%%%%% PACKAGE: DEFINE GLOBAL COMMAND %%%%%%%%%%%%%%%%%%%%

\def\gnewcommand{\g@star@or@long\gnew@command}
\def\grenewcommand{\g@star@or@long\grenew@command}
\def\g@star@or@long#1{% 
  \@ifstar{\let\l@ngrel@x\global#1}{\def\l@ngrel@x{\long\global}#1}}
\def\gnew@command#1{\@testopt{\@gnewcommand#1}0}
\def\@gnewcommand#1[#2]{%
  \kernel@ifnextchar [{\@gxargdef#1[#2]}%
                {\@argdef#1[#2]}}  
\let\@gxargdef\@xargdef
\patchcmd{\@gxargdef}{\def}{\gdef}{}{}
\let\grenew@command\renew@command
\patchcmd{\grenew@command}{\new@command}{\gnew@command}{}{}

%%%%%%%%%%%%%%%%%%%% PUBLIC FUNCTIONS %%%%%%%%%%%%%%%%%%%%

\newcommand\newmathsymbol[2]{%
    \NewDocumentCommand{#1}{s}{% define \⟨macro name⟩
      \IfBooleanTF{##1}% is starred variant called?
        {\ensuremath{#2}}%
        {\@throwunlessmath{#2}{#1}}%
    }%
}%

\newcommand\renewmathsymbol[2]{
    \RenewDocumentCommand{#1}{s}{% define \⟨macro name⟩
      \IfBooleanTF{##1}% is starred variant called?
        {\ensuremath{#2}}%
        {\@throwunlessmath{#2}{#1}}%
    }%
}%

\newcommand\providemathsymbol[2]{
    \ProvideDocumentCommand{#1}{s}{% define \⟨macro name⟩
      \IfBooleanTF{##1}% is starred variant called?
        {\ensuremath{#2}}%
        {\@throwunlessmath{#2}{#1}}%
    }%
}%

\newcommand\declaremathsymbol[2]{
    \DeclareDocumentCommand{#1}{s}{% define \⟨macro name⟩
      \IfBooleanTF{##1}% is starred variant called?
        {\ensuremath{#2}}%
        {\@throwunlessmath{#2}{#1}}%
    }%
}%


\newenvironment{equations}[1][\@columnsalignoneequalsign]
{
    \begin{IEEEeqnarray*}{#1l} % l for description column
}
{
    \end{IEEEeqnarray*}
}
\newenvironment{equations*}[1][\@columnsalignoneequalsign]
{
    \begin{IEEEeqnarray}{#1l} % l for description column
}
{
    \end{IEEEeqnarray}
}

\newcommand{\setcommentwidth}[1]
{
    \ifthenelse{\isempty{#1}} % parameter omitted?
    {
        \renewcommand{\@commentwidth}{0.33\columnwidth} % default value
    }
    {
        \renewcommand{\@commentwidth}{#1} % override value
    }
}

%%%%%%%%%%%%%%%%%%%% PUBLIC METHODS %%%%%%%%%%%%%%%%%%%%

% intertext
\patchcmd{\@IEEEeqnarray}{\relax}{\relax\intertext@}{}{}

\AtBeginEnvironment{equations}
{
    \@resetcomment  % Fix empty desciption in first line
    % Grant access to environment methods
    \let\comment\@setcomment
    \let\commentunit\@setcommentunit
    \let\qed\@qed
%
    \let\@builtinlabel\label
    \let\label\@yesnumber
    \let\sublabel\@yessubnumber
%
    \let\yessubnumber\IEEEyessubnumber    % Alias method \yessubnumber
%
    \pretocmd{\@IEEEeqnarraycr}{\@renderdescription}   % Paste the description column
}

% Fix no description because of missing \\ in last equation
\AtEndEnvironment{equations}{\@renderdescription}

%%%%%%%%%%%%%%%%%%%% DECLARE INTERFACE FUNCTIONS: %%%%%%%%%%%%%%%%%%%%

\newcommand{\@setcomment}[1]
{
    \@resetcomment
    \gnewcommand{\@description}
    {%
        &\quad%
        \begin{array}{|p{\@commentwidth}}%
            #1%
        \end{array}%
    }
}

\newcommand{\@setcommentunit}[1]
{
    \@resetunit
    \gnewcommand{\@description}
    {%
        &\quad%
        \left[%
            \unit{#1}%
        \right]%
    }
}

\newcommand{\@qed}
{
    \intertext{\raggedleft $\Box$}
}

\newcommand{\@yesnumber}[1]
{
    \yesnumber
    \ifthenelse{\isempty{#1}}{}{\@builtinlabel{#1}} % don't create a label for empty names
}

\newcommand{\@yessubnumber}[1]
{
    \IEEEyessubnumber
    \ifthenelse{\isempty{#1}}{}{\@builtinlabel{#1}} % don't create a label for empty names
}

%%%%%%%%%%%%%%%%%%%% DECLARE PRIVATE FUNCTIONS: %%%%%%%%%%%%%%%%%%%%

\newcommand{\@resetcomment}{\global\let\@description\relax} % \@description
\newcommand{\@resetunit}{\global\let\@description\relax} % undefine \@description
\newcommand{\@renderdescription}
{%
    \@ifundefined{@description}{}%
    {%
        \@description% Insert description
        \@resetcomment% Reset description for next line
    }
}

\newcommand\@throwunlessmath[2]{%
    \relax\ifmmode%
        {#1}%
    \else%
        {\PackageError{equations}{Use star variant #2* (without the space) outside math mode}{}}%
    \fi%
}

%%%%%%%%%%%%%%%%%%%% DECLARE PRIVATE VARIABLES %%%%%%%%%%%%%%%%%%%%

\newcommand{\@description}{}
\newcommand{\@columnsalignoneequalsign}{rCl}
\newcommand{\@commentwidth}{}
\setcommentwidth{} % initialize default value

\makeatother % Revoke access to private commands (Name contains an @).